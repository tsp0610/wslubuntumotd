#!/bin/bash

# ===========================================
# Secure SSH Setup + Custom MOTD - TSP NODES
# WSL + VPS Compatible
# ===========================================

clear

echo -e "\033[1;36müîê TSP NODES - Secure SSH Configuration\033[0m"
echo -e "\033[1;37m--------------------------------------\033[0m"

sleep 1

echo -e "\033[1;34m‚ñ∂ Updating SSH settings...\033[0m"

sudo bash -c 'cat <<EOF > /etc/ssh/sshd_config
# SSH LOGIN SETTINGS
PasswordAuthentication yes
PermitRootLogin yes
PubkeyAuthentication no
ChallengeResponseAuthentication no
UsePAM yes

# SECURITY
X11Forwarding no
AllowTcpForwarding yes
PrintMotd no

# SFTP
Subsystem sftp /usr/lib/openssh/sftp-server
EOF'

echo -e "\033[1;32m‚úî SSH configuration applied!\033[0m"

echo -e "\033[1;34m‚ñ∂ Restarting SSH...\033[0m"
sudo systemctl restart ssh 2>/dev/null || sudo service ssh restart
echo -e "\033[1;32m‚úî SSH restarted!\033[0m"

# ------------------------------------------------
# Install MOTD (VPS-style)
# ------------------------------------------------
echo -e "\033[1;34m‚ñ∂ Installing Custom MOTD...\033[0m"
bash <(curl -fsSL https://raw.githubusercontent.com/tsp0610/vps-motd/main/motd.sh)
echo -e "\033[1;32m‚úî MOTD installed!\033[0m"

# ------------------------------------------------
# WSL DETECTION & FIX
# ------------------------------------------------
if grep -qi microsoft /proc/version; then
  echo -e "\033[1;33m‚ö† WSL detected ‚Äî applying MOTD fix...\033[0m"

  mkdir -p /home/$SUDO_USER/.ssh

  cat <<'EOF' > /home/$SUDO_USER/.ssh/rc
#!/bin/bash
if [ -x /usr/bin/run-parts ]; then
  run-parts /etc/update-motd.d
fi
EOF

  chmod 700 /home/$SUDO_USER/.ssh
  chmod 600 /home/$SUDO_USER/.ssh/rc
  chown -R $SUDO_USER:$SUDO_USER /home/$SUDO_USER/.ssh

  echo -e "\033[1;32m‚úî WSL MOTD hook installed!\033[0m"
fi

# ------------------------------------------------
# FINAL MESSAGE
# ------------------------------------------------
clear

cat << "EOF"

‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù    ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
   ‚ñà‚ñà‚ïë   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù     ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë
   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë         ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù         ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

EOF

echo -e "\033[1;32müéâ SSH + MOTD setup completed successfully!\033[0m"
echo -e "\033[1;36m‚ú® TSP NODES ‚Äî Ready to go üöÄ\033[0m"
